{% extends 'base.html' %}
{% block title %} {{ title }} Post Assignment {% endblock %}
{% block content %}
{% load static %}
<body>
    <section class="call-to-action text-white text-center" style="background:url('{% static 'images/WorkPlace-2.jpg'%}') no-repeat center center;background-size:cover;">
        <div class="overlay"></div>
    </section>
    <!-- Start: 2 Rows 1+2 Columns --><div>
    <div class="container">
        {% if trabajo %}
            <form action="{% url 'edit_post_assignment' trabajo.id %}" method="POST" enctype="multipart/form-data">
        {% elif trabajo_id %}
            <form action="{% url 'edit_post_assignment' trabajo_id %}" method="POST" enctype="multipart/form-data">
        {% else %}
            <form action="{% url 'post_assignment' %}" method="POST" enctype="multipart/form-data">
        {% endif %}
        {% csrf_token %}
        <div class="progress mt-3">
            <div class="progress-bar bg-success progress-bar-striped progress-bar-animated" aria-valuemin="0" aria-valuemax="100" id="progress_bar">0%</div>
        </div>
        <div class="row">
            <div class="col-md-6">
                <div class="Push-20" style="height: 28.8px;"></div>
                <h4 class="text-left">Assignment Field</h4>
                <div class="dropdown">
                    <select class="row form-control col-5" name="area" id="area" required>
                        <option value>Select...</option>
                        <option {% if option == 0 or form.area.value == 'Literature'%}selected{% endif %} value="Literature">Literature</option>
                        <option {% if option == 1 or form.area.value == 'Social Sciences' %}selected{% endif %} value="Social Sciences">Social Sciences</option>
                        <option {% if option == 2 or form.area.value == 'History' %}selected{% endif %} value="History">History</option>
                        <option {% if option == 3 or form.area.value == 'Nature Sciences' %}selected{% endif %} value="Nature Sciences">Nature Sciences</option>
                        <option {% if option == 4 or form.area.value == 'Biology' %}selected{% endif %} value="Biology">Biology</option>
                        <option {% if option == 5 or form.area.value == 'Chemistry' %}selected{% endif %} value="Chemistry">Chemistry</option>
                        <option {% if option == 6 or form.area.value == 'Mathematics' %}selected{% endif %} value="Mathematics">Mathematics</option>
                        <option {% if option == 7 or form.area.value == 'Physics' %}selected{% endif %} value="Physics">Physics</option>
                        <option {% if option == 8 or form.area.value == 'Engineering' %}selected{% endif %} value="Engineering">Engineering</option>
                        <option {% if option == 9 or form.area.value == 'Computer Sciences' %}selected{% endif %} value="Computer Sciences">Computer Sciences</option>
                    </select>
                </div>
                
                {% for error in form.area.errors %}
                    <small class="text-danger">{{ error }}</small>
                {% endfor %}
                <small class="form-text text-muted" style="margin: 0px;">Write assignment title</small>
                <textarea class="row form-control" name="titulo" placeholder="Type..." id="title" required>{% if form.errors %}{{ form.titulo.value }}{% elif trabajo.titulo %}{{ trabajo.titulo }}{% endif %}</textarea>
                {% for error in form.titulo.errors %}
                    <small class="text-danger">{{ error }}</small>
                {% endfor %}
                <br>
                <h4 class="text-left">Assignment Description</h4>
                <small class="form-text text-muted">Describe in detail your assignment, include requirements, complexity, format and related topics</small>
                <textarea class="row form-control" style="height:150px" name="descripcion" id="description" placeholder="Type..." required>{% if form.errors %}{{ form.descripcion.value }}{% else %}{{ trabajo.descripcion }}{% endif %}</textarea>
                {% for error in form.descripcion.errors %}
                    <small class="text-danger">{{ error }}</small>
                {% endfor %}
                <div class="clearfix"></div>
            </div>
            <div class="col-md-6">
                <div class="Push-20" style="height: 14.5px;"></div>
                <h4 class="text-left">Dead Line</h4>
                <div class="row">
                    <input class="col form-control" type="datetime-local" id="date" name="fecha_expiracion" required
                        value="{% if form.errors %}{{ form.fecha_expiracion.value }}{% else %}{{ trabajo.fecha_expiracion|date:"c"|slice:':-9' }}{% endif %}">
                </div>
                {% for error in form.fecha_expiracion.errors %}
                    <small class="text-danger">{{ error }}</small>
                {% endfor %}
                </br>
                <h4 class="text-left">Related Documents</h4><small class="form-text text-muted">Upload any assignment related documents (rubrics, forms, questionnaires, documents to be filld and any main format documents)</small>
                <div class="form-group files">
                    <input type="file" multiple onchange="readURL(this);" class="custom-file-input" style="cursor: pointer" name="archivos" id="archivos"
                        value="{{ files }}">
                </div>
            </div>
        </div>
    </div>
</div>

<div class="Push-20" style="height: 14.4px;"></div>
<hr>
    <div>
        <div class="container">
            <div class="row">
                <div class="col-lg-8 mx-auto">
                    <h1 class="text-center">PREVIEW</h1><br>
                    <h4 class="text-left" id="title_area"></h4>
                    <small class="form-text text-muted" style="margin: 0px;" id="date2"><br></small>
                    <div class="Push-20"></div>
                    <h4 class="text-left" id="description_title">Assignment Description</h4>
                    <p class="form-control-plaintext" id="description2"></p>
                    <div class="Push-20" style="height: 8.8px;"></div>
                    <h5 class="text-left" id="archivos_title">Related Documents List</h5>
                    <div id="archivos2"></div>
                    <h5 class="text-left" style="width: 450px;" id="archivos_title_2">Related Documents List</h5>
                    {% for archivo in trabajo.archivos.all %}
                        <div id="file_text_2">
                            +&nbsp<a class="" href="{% url 'media/' archivo %}">{{ archivo }}</a>
                        </div>
                    {% endfor %}
                    {% for file in files %}
                        <h3 style="color: green;">FILES from validation error</h3>
                        +&nbsp<a class="" href="{% url 'media/' file %}">{{ file.nombre }}</a>
                        <input type="hidden" name="files_from_validation" value="{{ file.pk }}">
                    {% endfor %}
                    <div id="frame_div"></div>
                    <div class="Push-20" style="height: 13.8px;"></div>
                    <div class="Push-20" style="height: 30px;"></div>
                    <div class="col-7 mx-auto"><button class="btn-lg btn-primary border rounded col" type="submit">Submit</button></div>
                </div>
            </div>
        </div>
    </div>
</form>
<div class="Push-20" style="height: 14.4px;"></div>

<section class="call-to-action text-white text-center" style="background:url({% static 'images/Desk-1.jpg' %}) no-repeat center center;background-size:cover;">
    <div class="overlay"></div>
</section>

</body>
{% endblock %}

{% block js %}
<script>
    $(document).ready(progress);
    $('#area').on('change', progress);
    $('#title').on('keyup', progress);
    $('#description').on('keyup', progress);
    $('#date').on('change', progress);
    $('#archivos').on('change', progress);

    function readURL(input) {
        files = input.files
        console.log(files)
        
        if(files){
            $('#frame_div').show();
            $('#frame_div').html("");
            for(var i = 0; i < files.length; i++){
                
                //console.log(files[i].name)
                if (/\.(jpe?g|png|gif|pdf|md|txt|py|html|css|js|ts|php)$/i.test(files[i].name) ) {
                    (function(file) {
                        var reader = new FileReader();
                        console.log(file.name)
                        $('#frame_div').append(` <span class="m-3">+&nbsp` + file.name + `</span><br>`);
                        reader.onload = function (r) {
                            console.log(r)
                            $('#frame_div').append(
                            `   <div class="embed-responsive embed-responsive-21by9 shadow my-3" id="frame">
                                    <iframe src="` + r.target.result + `" id="file_iframe" class="embed-responsive-item"></iframe>
                                </div>                    
                            `);
                        };
                        reader.readAsDataURL(file);
                    })(files[i]);
                }else{
                    $('#frame_div').append(`
                        <span class="m-3">+&nbsp` + files[i].name + `</span><span style="color:red;">Unable to display a file preview.</span><br>
                    `);
                }
            }
        }else{
            console.log('else')
            //$('#frame').hide();
            //$('#file_text').html("Unable to display a file preview.");
        }
    }

    function progress(){
        var area = $.trim($('#area').val());
        var title = $.trim($('#title').val());
        var description = $.trim($('#description').val());
        var date = $.trim($('#date').val());
        var archivos = $.trim($('#archivos').val());
        var components = [area, title, description, date]
        var cont = 0;
        for(var i=0; i<components.length; i++){
            if(components[i] != ""){
                cont = cont + 1;
            }
        }

        var percent = (cont / components.length) * 100;
        $('#progress_bar').css('width', percent + '%');
        $('#progress_bar').html(percent + '%');

        if(title != "" || area != "" ){
            $('#title_area').html(title + ' - ' + area);
        }else{
            $('#title_area').html("");
        }
        if(date != ""){
            var datetime = new Date(date);
            var mes = datetime.getMonth();
            var dia = datetime.getDate();
            var año = datetime.getFullYear();
            var horas = datetime.getHours();
            var minutos = datetime.getMinutes();
            $('#date2').show();
            $('#date2').html(
                (mes > 8) ? (mes + 1) : '0' + (mes + 1)  + '/' + ((dia > 9) ? dia : '0' + dia)  + '/' + año + ' ' + 
                ((horas > 9) ? horas : '0' + horas)  + ':' + ((minutos > 9) ? minutos : '0' + minutos)
            )
        }else{
            $('#date2').hide();
        }
        if(description != ""){
            $('#description_title').show();
            $('#description2').html(description.replace(/\r\n|\r|\n/g,"</br>"));
        }else{
            $('#description_title').hide();
            $('#description2').html("");
        }

        if(archivos){
            $('#archivos_title').show();
            //var nombre_archivo = archivos.split('\\')[2];
            //$('#archivos2').html('+ ' + nombre_archivo);
            //$('#archivos_title_2').hide();
            //$('#file_text_2').hide();
        }else{
            $('#archivos_title').hide();
            //$('#archivos2').html("");
            //$('#frame').hide();
        }
    }

    
</script>
{% endblock js %}