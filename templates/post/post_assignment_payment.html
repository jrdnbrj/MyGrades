{% extends 'base.html' %}
{% block title %} Post Assignment {% endblock %}
{% block content %}
{% load static %}
<section class="call-to-action text-white text-center" style="background:url('{% static 'images/WorkPlace-2.jpg'%}') no-repeat center center;background-size:cover;">
    <div class="overlay"></div>
</section>

<div class="container">
    <div class="row">
        <div class="col-lg-7 mx-auto">
            <h2 class="text-center my-5">Assignment Payment</h2>
            <section class="mb-4 mx-5">
                <p class="text-justify">You are about to publish <strong>"{{ trabajo.titulo }}"</strong> to improve YourGrades!!!</p>
                <p class="text-justify">
                    Once you make the payment, your assignment will be public and someone can take it, meanwhile it will remain with a hidden status. 
                    If you want to pay later or continue editing it, you can do it from your <a href="{% url 'user_assignments' %}">Assignments</a> page.
                </p>
                <p class="text-right text-muted"><small>Amount to be paid: ${{ trabajo.precio }}</small></p>
            </section>
            <form method="POST" action="{% url 'post_assignment_payment' trabajo.id %}">{% csrf_token %}
                <div class="form-group"><div id="paypal-button-container"></div></div>
                {% comment %} <div class="form-group"><button class="btn-lg btn-outline-primary rounded border-primary btn-block col-5 mx-auto" type="submit">Ready</button></div> {% endcomment %}
            </form>
        </div>
        <div class="row mx-auto my-4 d-flex flex-row-reverse">
            <button class="btn btn-outline-warning rounded border my-2" type="button" onclick="location.href='{% url 'user_assignments' %}'">View Assignments</button>
            <button class="btn btn-outline-info rounded border mx-2 my-2" type="button" onclick="location.href='{% url 'post_assignment' %}'">Post new Assignment</button>
            <button class="btn btn-outline-success rounded border my-2" type="button" onclick="location.href='{% url 'work_place' %}'">Go to WorkPlace</button>
        </div>
    </div>
</div>

<section class="call-to-action text-white text-center" style="background:url({% static 'images/Desk-1.jpg' %}) no-repeat center center;background-size:cover;">
    <div class="overlay"></div>
</section>
{% endblock %}

{% block js %}
    <script src="https://www.paypal.com/sdk/js?client-id=AUfE4lMYpalZDXKaXrU-OBU3EpQkEqK8TlpiYplZ3mdJAjtaeSkrt1iktz0GFlMgdPKviucsr5F8BD0G&currency=USD"></script>
    <script>
        
        const csrfToken = $('[name="csrfmiddlewaretoken"]').val();

        paypal.Buttons({

            style: {
                color:  'blue',
                shape:  'pill',
                label:  'pay',
                height: 40
            },

            createOrder: function(data, actions) {
                console.log('Trabajo ID: ' + {{ trabajo.id }} )
                return fetch('{% url 'paypal_create' trabajo.id %}', {
                    method: 'POST',
                    headers: {
                        'content-type': 'application/json',
                        'X-CSRFToken': csrfToken,
                    }
                }).then(function(res) {
                    console.log('1 createOrder')
                    console.log(res)
                    return res.json();
                }).then(function(data) {
                    console.log(data)
                    console.log('2 cerateOrder')
                    return data.id; // Use the same key name for order ID on the client and server
                });
                

            },
            
            onError: function(err) {
                alert('It seems that there was an error with the transaction, please try again or contact us on the Customer Support.')
                console.log(err)
            },

            onCancel: function (data) {
                alert('You have canceled the transaction. Not sure what you are doing? Get in touch with us on the Customer Support.')
                console.log(data)
            },

            onApprove: function(data, actions) {
                console.log(data)
                return fetch('/paypal/' + data.orderID + '/capture/' + {{ trabajo.id }}, {
                    method: 'POST',
                    headers: {
                        'content-type': 'application/json',
                        'X-CSRFToken': csrfToken,
                    }
                }).then(function(res) {
                    console.log('3. aprrove')
                    console.log(res)
                    return res.json();
                }).then(function(orderData) {
                    console.log('4. then')
                    console.log(orderData)
                    const errorDetail = orderData.details
                    console.log(errorDetail)
                    if (errorDetail) {
                        if (errorDetail.issue === 'INSTRUMENT_DECLINED') return actions.restart()
                        const msg = errorDetail;
                        return alert(msg);
                    }
                    console.log('Transaction completed by ' + orderData.payer.name.given_name)
                    location.reload()
                })
            }

        }).render('#paypal-button-container');
    </script>
{% endblock js %}