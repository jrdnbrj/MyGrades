{% extends 'base.html' %}
{% block title %} Post Assignment {% endblock %}
{% block content %}
{% load static %}
<section class="call-to-action text-white text-center" style="background:url('{% static 'images/WorkPlace-2.jpg'%}') no-repeat center center;background-size:cover;">
    <div class="overlay"></div>
</section>

<div class="container">
    <div class="row">
        <div class="col-lg-7 mx-auto">
            <h2 class="text-center my-5">Assignment Payment</h2>
            <section class="mb-4 mx-5">
                <p class="text-justify">You are about to publish <strong>"{{ trabajo.titulo }}"</strong> to improve YourGrades!!!</p>
                <p class="text-justify">
                    Once you make the payment, your assignment will be public and someone can take it, meanwhile it will remain with a hidden status. 
                    If you want to pay later or continue editing it, you can do it from your <a href="{% url 'user_assignments' %}">Assignments</a> page.
                </p>
                <p class="text-right text-muted"><small>Amount to be paid: ${{ trabajo.precio }}</small></p>
            </section>
            <form method="POST" action="{% url 'post_assignment_payment' trabajo.id %}">{% csrf_token %}
                <div class="form-group"><div id="paypal-button-container"></div></div>
                {% comment %} <div class="form-group"><button class="btn-lg btn-outline-primary rounded border-primary btn-block col-5 mx-auto" type="submit">Ready</button></div> {% endcomment %}
            </form>
        </div>
        <div class="row mx-auto my-4 d-flex flex-row-reverse">
            <button class="btn btn-outline-warning rounded border my-2" type="button" onclick="location.href='{% url 'user_assignments' %}'">View Assignments</button>
            <button class="btn btn-outline-info rounded border mx-2 my-2" type="button" onclick="location.href='{% url 'post_assignment' %}'">Post new Assignment</button>
            <button class="btn btn-outline-success rounded border my-2" type="button" onclick="location.href='{% url 'work_place' %}'">Go to WorkPlace</button>
        </div>
    </div>
</div>

<section class="call-to-action text-white text-center" style="background:url({% static 'images/Desk-1.jpg' %}) no-repeat center center;background-size:cover;">
    <div class="overlay"></div>
</section>
{% endblock %}

{% block js %}
    <script src="https://www.paypal.com/sdk/js?client-id=AWLMBI3BwXhtXFpMZw-BnZLMvw3NjS_52qMjdQPx-e7Oe7Q7_x33nyg4EXcMHVu9ZhdNw_0CNfpgOR2M&currency=USD"></script>
    <script>
        
        const csrfToken = $('[name="csrfmiddlewaretoken"]').val();
        // const price = {{ trabajo.precio }} || 0
        const price = 0.01
        // const trabajo_id = {{ trabajo.id }} || 0
        const trabajo_id = 2

        paypal.Buttons({
            style: {
                color:  'blue',
                shape:  'pill',
                label:  'pay',
                height: 40
            },
            createOrder: function(data, actions) {
                console.log('Trabajo ID: ' + trabajo_id )
                fetch('{% url 'verificar_pago' %}', {
                    method: 'GET',
                    body: JSON.stringify({ orderID: data.orderID })
                }).then(function(res) {
                    return res.json();
                }).then(function(details) {
                    alert(details.message);
                })
                return actions.order.create({
                    purchase_units: [{
                        amount: {
                            value: price.toFixed(2)
                        }
                    }]
                });
            },
            onError: function(err) {
                alert('EERRRROORRR!!!!!')
                console.log(err)
            },
            onCancel: function (data) {
                alert('CANCEL!!!!!')
                console.log(data)
            },
            onApprove: function(data) {
                return fetch('{% url 'pago' %}', {
                    method: 'POST',
                    headers: {
                        'content-type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({ orderID: data.orderID })
                }).then(function(res) {
                    return res.json();
                }).then(function(details) {
                    alert(details.message);
                })
            }

        }).render('#paypal-button-container');
    </script>
{% endblock js %}